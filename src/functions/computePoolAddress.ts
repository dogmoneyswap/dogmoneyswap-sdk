import { Fee } from '../enums'
import { Token } from '../entities'
import { computePoolInitCodeHash } from './computePoolInitCodeHash'
import { defaultAbiCoder } from '@ethersproject/abi'
import { getCreate2Address } from '@ethersproject/address'
import { keccak256 } from '@ethersproject/solidity'

const MASTER_DEPLOYER_ADDRESS = '0x7166D2efffCA02c6A21A235732131660c3E61f9F'

const CONSTANT_PRODUCT_POOL_CREATION_CODE =
  '0x61018060405260016008553480156200001757600080fd5b5060405162003c3a38038062003c3a8339810160408190526200003a91620004b6565b604080518082018252600e81526d29bab9b434902628102a37b5b2b760911b6020918201528151808301835260018152603160f81b9082015281517f8b73c3c69bb8fe3d512ecc4cf759cc79239f7b179b0ffacaa9a75d522b39400f918101919091527fc2bf45081e840722410522aa366600d7fe4da5bfb5a5b417f4d5125b4ed180a4918101919091527fc89efdaa54c0f20c7adf612882df0950f5a951637e0307cdcb4c672f298b8bc6606082015246608082018190523060a08301529060c0016040516020818303038152906040528051906020012060808181525050506000806000808580602001905181019062000137919062000456565b929650909450925090506001600160a01b038416620001af5760405162461bcd60e51b815260206004820152602960248201527f436f6e7374616e7450726f64756374506f6f6c57697468545741503a205a45526044820152684f5f4144445245535360b81b60648201526084015b60405180910390fd5b826001600160a01b0316846001600160a01b031614156200022c5760405162461bcd60e51b815260206004820152603060248201527f436f6e7374616e7450726f64756374506f6f6c57697468545741503a2049444560448201526f4e544943414c5f41444452455353455360801b6064820152608401620001a6565b612710821115620002965760405162461bcd60e51b815260206004820152602d60248201527f436f6e7374616e7450726f64756374506f6f6c57697468545741503a20494e5660448201526c414c49445f535741505f46454560981b6064820152608401620001a6565b6001600160601b0319606085811b82166101405284901b166101605260a0829052620002c582612710620005a7565b60c08181525050846001600160a01b0316634da318276040518163ffffffff1660e01b815260040160206040518083038186803b1580156200030657600080fd5b505afa1580156200031b573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906200034191906200042f565b6001600160a01b0316610100816001600160a01b031660601b81525050846001600160a01b0316630c0a0cd26040518163ffffffff1660e01b815260040160206040518083038186803b1580156200039857600080fd5b505afa158015620003ad573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190620003d391906200042f565b6001600160601b0319606091821b811660e0529086901b1661012052600160085580156200041157600780546001600160e01b0316600160e01b1790555b505050505050620005fc565b80516200042a81620005e3565b919050565b6000602082840312156200044257600080fd5b81516200044f81620005e3565b9392505050565b600080600080608085870312156200046d57600080fd5b84516200047a81620005e3565b60208601519094506200048d81620005e3565b6040860151606087015191945092508015158114620004ab57600080fd5b939692955090935050565b60008060408385031215620004ca57600080fd5b82516001600160401b0380821115620004e257600080fd5b818501915085601f830112620004f757600080fd5b8151818111156200050c576200050c620005cd565b604051601f8201601f19908116603f01168101908382118183101715620005375762000537620005cd565b816040528281526020935088848487010111156200055457600080fd5b600091505b8282101562000578578482018401518183018501529083019062000559565b828211156200058a5760008484830101525b95506200059c9150508582016200041d565b925050509250929050565b600082821015620005c857634e487b7160e01b600052601160045260246000fd5b500390565b634e487b7160e01b600052604160045260246000fd5b6001600160a01b0381168114620005f957600080fd5b50565b60805160a05160c05160e05160601c6101005160601c6101205160601c6101405160601c6101605160601c6134e9620007516000396000818161057a0152818161075a015281816107cd015281816108cf0152818161097d015281816110480152818161115e015281816113920152818161140d0152818161168e01528181611cbf01528181611d5f01528181611da00152612643015260008181610308015281816106d601528181610a6201528181610ad501528181610bd70152818161101c015281816110f50152818161133d015281816114c60152818161162001528181611a2301528181611e9c01526125590152600081816105530152612a510152600081816103d3015281816123dd015281816124b90152818161258c01526126740152600081816102bc0152612b350152600061231b015260006103fa0152600081816103ac015261201801526134e96000f3fe608060405234801561001057600080fd5b50600436106101e55760003560e01c80635a3d54931161010f578063a69840a8116100a2578063cf58879a11610071578063cf58879a1461054e578063d21220a714610575578063d505accf1461059c578063dd62ed3e146105b157600080fd5b8063a69840a8146104ee578063a8f1f52e14610515578063a9059cbb14610528578063af8c09bf1461053b57600080fd5b80637464fc3d116100de5780637464fc3d146104765780637ba0e2e71461047f5780637ecebe001461049257806395d89b41146104b257600080fd5b80635a3d549314610425578063627dd56a1461042e57806367e4ac2c1461044157806370a082311461045657600080fd5b806323b872dd116101875780633644e515116101565780633644e515146103a75780634da31827146103ce57806354cf2aeb146103f55780635909c0d51461041c57600080fd5b806323b872dd146103335780632a07b6c71461034657806330adf81f14610366578063313ce5671461038d57600080fd5b8063095ea7b3116101c3578063095ea7b3146102945780630c0a0cd2146102b75780630dfe16811461030357806318160ddd1461032a57600080fd5b8063053da1c8146101ea57806306fdde03146102105780630902f1ac14610259575b600080fd5b6101fd6101f83660046130c9565b6105dc565b6040519081526020015b60405180910390f35b61024c6040518060400160405280600e81526020017f5375736869204c5020546f6b656e00000000000000000000000000000000000081525081565b60405161020791906132f2565b610261610c93565b604080516dffffffffffffffffffffffffffff948516815293909216602084015263ffffffff1690820152606001610207565b6102a76102a2366004612fac565b610cfc565b6040519015158152602001610207565b6102de7f000000000000000000000000000000000000000000000000000000000000000081565b60405173ffffffffffffffffffffffffffffffffffffffff9091168152602001610207565b6102de7f000000000000000000000000000000000000000000000000000000000000000081565b6101fd60005481565b6102a7610341366004613011565b610d75565b6103596103543660046130c9565b610ec1565b604051610207919061328d565b6101fd7f6e71edae12b1b97f4d1f60370fef10105fa2faae0126114a169c64845d6126c981565b610395601281565b60405160ff9091168152602001610207565b6101fd7f000000000000000000000000000000000000000000000000000000000000000081565b6102de7f000000000000000000000000000000000000000000000000000000000000000081565b6101fd7f000000000000000000000000000000000000000000000000000000000000000081565b6101fd60045481565b6101fd60055481565b6101fd61043c3660046130c9565b611241565b6104496115fe565b6040516102079190613233565b6101fd610464366004612dfd565b60016020526000908152604090205481565b6101fd60065481565b6101fd61048d3660046130c9565b6116fd565b6101fd6104a0366004612dfd565b60036020526000908152604090205481565b61024c6040518060400160405280600381526020017f534c50000000000000000000000000000000000000000000000000000000000081525081565b6101fd7f54726964656e743a436f6e7374616e7450726f6475637400000000000000000081565b6101fd6105233660046130c9565b6119ac565b6102a7610536366004612fac565b611adf565b6101fd6105493660046130c9565b611b64565b6102de7f000000000000000000000000000000000000000000000000000000000000000081565b6102de7f000000000000000000000000000000000000000000000000000000000000000081565b6105af6105aa366004613052565b611f5f565b005b6101fd6105bf366004612fd8565b600260209081526000928352604080842090915290825290205481565b600060085460011461064f576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152600d60248201527f4d4952494e3a204c4f434b45440000000000000000000000000000000000000060448201526064015b60405180910390fd5b600260085560008080808061066687890189612e68565b9450945094509450945060008060006106ce6007546dffffffffffffffffffffffffffff808216926e01000000000000000000000000000083049091169163ffffffff7c01000000000000000000000000000000000000000000000000000000009091041690565b9250925092507f000000000000000000000000000000000000000000000000000000000000000073ffffffffffffffffffffffffffffffffffffffff168873ffffffffffffffffffffffffffffffffffffffff16141561097b5761075385846dffffffffffffffffffffffffffff16846dffffffffffffffffffffffffffff16612313565b98506107817f00000000000000000000000000000000000000000000000000000000000000008a8989612376565b6040517fc380f0b000000000000000000000000000000000000000000000000000000000815273ffffffffffffffffffffffffffffffffffffffff88169063c380f0b0906107fb908b907f0000000000000000000000000000000000000000000000000000000000000000908a908f908b906004016131e3565b600060405180830381600087803b15801561081557600080fd5b505af1158015610829573d6000803e3d6000fd5b5050505060008061083861251c565b9092509050866108586dffffffffffffffffffffffffffff87168461336e565b10156108c0576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152601660248201527f494e53554646494349454e545f414d4f554e545f494e000000000000000000006044820152606401610646565b6108cd82828787876126f6565b7f000000000000000000000000000000000000000000000000000000000000000073ffffffffffffffffffffffffffffffffffffffff168a73ffffffffffffffffffffffffffffffffffffffff168a73ffffffffffffffffffffffffffffffffffffffff167fcd3829a3813dc3cdd188fd3d01dcf3268c16be2fdd2dd21d0665418816e460628a8f60405161096c929190918252602082015260400190565b60405180910390a45050610c7f565b7f000000000000000000000000000000000000000000000000000000000000000073ffffffffffffffffffffffffffffffffffffffff168873ffffffffffffffffffffffffffffffffffffffff1614610a30576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152601360248201527f494e56414c49445f494e5055545f544f4b454e000000000000000000000000006044820152606401610646565b610a5b85836dffffffffffffffffffffffffffff16856dffffffffffffffffffffffffffff16612313565b9850610a897f00000000000000000000000000000000000000000000000000000000000000008a8989612376565b6040517fc380f0b000000000000000000000000000000000000000000000000000000000815273ffffffffffffffffffffffffffffffffffffffff88169063c380f0b090610b03908b907f0000000000000000000000000000000000000000000000000000000000000000908a908f908b906004016131e3565b600060405180830381600087803b158015610b1d57600080fd5b505af1158015610b31573d6000803e3d6000fd5b50505050600080610b4061251c565b909250905086610b606dffffffffffffffffffffffffffff86168361336e565b1015610bc8576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152601660248201527f494e53554646494349454e545f414d4f554e545f494e000000000000000000006044820152606401610646565b610bd582828787876126f6565b7f000000000000000000000000000000000000000000000000000000000000000073ffffffffffffffffffffffffffffffffffffffff168a73ffffffffffffffffffffffffffffffffffffffff168a73ffffffffffffffffffffffffffffffffffffffff167fcd3829a3813dc3cdd188fd3d01dcf3268c16be2fdd2dd21d0665418816e460628a8f604051610c74929190918252602082015260400190565b60405180910390a450505b505060016008555094979650505050505050565b6000806000610cf16007546dffffffffffffffffffffffffffff808216926e01000000000000000000000000000083049091169163ffffffff7c01000000000000000000000000000000000000000000000000000000009091041690565b925092509250909192565b33600081815260026020908152604080832073ffffffffffffffffffffffffffffffffffffffff8716808552925280832085905551919290917f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b92590610d649086815260200190565b60405180910390a350600192915050565b73ffffffffffffffffffffffffffffffffffffffff831660009081526002602090815260408083203384529091528120547fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff14610e125773ffffffffffffffffffffffffffffffffffffffff8416600090815260026020908152604080832033845290915281208054849290610e0c90849061336e565b90915550505b73ffffffffffffffffffffffffffffffffffffffff841660009081526001602052604081208054849290610e4790849061336e565b909155505073ffffffffffffffffffffffffffffffffffffffff808416600081815260016020526040908190208054860190555190918616907fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef90610eaf9086815260200190565b60405180910390a35060019392505050565b6060600854600114610f2f576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152600d60248201527f4d4952494e3a204c4f434b4544000000000000000000000000000000000000006044820152606401610646565b6002600855600080610f4384860186612f77565b915091506000806000610fa56007546dffffffffffffffffffffffffffff808216926e01000000000000000000000000000083049091169163ffffffff7c01000000000000000000000000000000000000000000000000000000009091041690565b925092509250600080610fb661251c565b60008054308252600160205260409091205492945090925090610fda878784612a17565b50600082610fe88684613331565b610ff2919061331d565b90506000836110018685613331565b61100b919061331d565b90506110173084612b65565b6110437f0000000000000000000000000000000000000000000000000000000000000000838d8d612376565b61106f7f0000000000000000000000000000000000000000000000000000000000000000828d8d612376565b611079828761336e565b9550611085818661336e565b945061109486868b8b8b6126f6565b6110a66110a18688613331565b612bf8565b6006556040805160028082526060820190925290816020015b60408051808201909152600080825260208201528152602001906001900390816110bf579050509b5060405180604001604052807f000000000000000000000000000000000000000000000000000000000000000073ffffffffffffffffffffffffffffffffffffffff168152602001838152508c60008151811061114657611146613430565b602002602001018190525060405180604001604052807f000000000000000000000000000000000000000000000000000000000000000073ffffffffffffffffffffffffffffffffffffffff168152602001828152508c6001815181106111af576111af613430565b60200260200101819052508a73ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff167fdccd412f0b1252819cb1fd330b93224ca42612892bb3f4f789976e6d819364968484604051611222929190918252602082015260400190565b60405180910390a35050600160085550979a9950505050505050505050565b60006008546001146112af576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152600660248201527f4c4f434b454400000000000000000000000000000000000000000000000000006044820152606401610646565b600080806112bf85870187612e21565b92509250925060008060006113236007546dffffffffffffffffffffffffffff808216926e01000000000000000000000000000083049091169163ffffffff7c01000000000000000000000000000000000000000000000000000000009091041690565b92509250925060008061133461251c565b915091506000807f000000000000000000000000000000000000000000000000000000000000000073ffffffffffffffffffffffffffffffffffffffff168a73ffffffffffffffffffffffffffffffffffffffff16141561140b57507f00000000000000000000000000000000000000000000000000000000000000006113cb6dffffffffffffffffffffffffffff88168561336e565b91506113f882886dffffffffffffffffffffffffffff16886dffffffffffffffffffffffffffff16612313565b9a506114048b8461336e565b925061154e565b7f000000000000000000000000000000000000000000000000000000000000000073ffffffffffffffffffffffffffffffffffffffff168a73ffffffffffffffffffffffffffffffffffffffff16146114c0576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152601360248201527f494e56414c49445f494e5055545f544f4b454e000000000000000000000000006044820152606401610646565b506007547f000000000000000000000000000000000000000000000000000000000000000090611512906e01000000000000000000000000000090046dffffffffffffffffffffffffffff168461336e565b915061153f82876dffffffffffffffffffffffffffff16896dffffffffffffffffffffffffffff16612313565b9a5061154b8b8561336e565b93505b61155a818c8b8b612376565b61156784848989896126f6565b8073ffffffffffffffffffffffffffffffffffffffff168a73ffffffffffffffffffffffffffffffffffffffff168a73ffffffffffffffffffffffffffffffffffffffff167fcd3829a3813dc3cdd188fd3d01dcf3268c16be2fdd2dd21d0665418816e46062858f6040516115e6929190918252602082015260400190565b60405180910390a45050505050505050505092915050565b60408051600280825260608083018452926020830190803683370190505090507f00000000000000000000000000000000000000000000000000000000000000008160008151811061165257611652613430565b602002602001019073ffffffffffffffffffffffffffffffffffffffff16908173ffffffffffffffffffffffffffffffffffffffff16815250507f0000000000000000000000000000000000000000000000000000000000000000816001815181106116c0576116c0613430565b602002602001019073ffffffffffffffffffffffffffffffffffffffff16908173ffffffffffffffffffffffffffffffffffffffff168152505090565b600060085460011461176b576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152600d60248201527f4d4952494e3a204c4f434b4544000000000000000000000000000000000000006044820152606401610646565b6002600855600061177e83850185612dfd565b905060008060006117de6007546dffffffffffffffffffffffffffff808216926e01000000000000000000000000000083049091169163ffffffff7c01000000000000000000000000000000000000000000000000000000009091041690565b9250925092506000806117ef61251c565b6000549193509150611802868683612a17565b50600061181f6dffffffffffffffffffffffffffff88168561336e565b9050600061183d6dffffffffffffffffffffffffffff88168561336e565b9050600061184e6110a18688613331565b905083611875576118616103e88261336e565b9a5061187060006103e8612d7d565b6118bd565b60006118976110a16dffffffffffffffffffffffffffff808c16908d16613331565b905080856118a5828561336e565b6118af9190613331565b6118b9919061331d565b9b50505b60008b11611927576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152601d60248201527f494e53554646494349454e545f4c49515549444954595f4d494e5445440000006044820152606401610646565b6119318a8c612d7d565b61193e86868b8b8b6126f6565b6006819055604080518481526020810184905273ffffffffffffffffffffffffffffffffffffffff8c169133917fdbba30eb0402b389513e87f51f4db2db80bed454384ec6925a24097c3548a02a910160405180910390a35050600160085550969998505050505050505050565b600080806119bc84860186612fac565b91509150600080611a1c6007546dffffffffffffffffffffffffffff808216926e01000000000000000000000000000083049091169163ffffffff7c01000000000000000000000000000000000000000000000000000000009091041690565b50915091507f000000000000000000000000000000000000000000000000000000000000000073ffffffffffffffffffffffffffffffffffffffff168473ffffffffffffffffffffffffffffffffffffffff161415611aa757611aa083836dffffffffffffffffffffffffffff16836dffffffffffffffffffffffffffff16612313565b9450611ad5565b611ad283826dffffffffffffffffffffffffffff16846dffffffffffffffffffffffffffff16612313565b94505b5050505092915050565b33600090815260016020526040812080548391908390611b0090849061336e565b909155505073ffffffffffffffffffffffffffffffffffffffff8316600081815260016020526040908190208054850190555133907fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef90610d649086815260200190565b6000600854600114611bd2576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152600d60248201527f4d4952494e3a204c4f434b4544000000000000000000000000000000000000006044820152606401610646565b600260085560008080611be785870187612e21565b9250925092506000806000611c4b6007546dffffffffffffffffffffffffffff808216926e01000000000000000000000000000083049091169163ffffffff7c01000000000000000000000000000000000000000000000000000000009091041690565b925092509250600080611c5c61251c565b60008054308252600160205260409091205492945090925090611c80878784612a17565b50600082611c8e8684613331565b611c98919061331d565b9050600083611ca78685613331565b611cb1919061331d565b9050611cbd3084612b65565b7f000000000000000000000000000000000000000000000000000000000000000073ffffffffffffffffffffffffffffffffffffffff168c73ffffffffffffffffffffffffffffffffffffffff161415611d9e57611d4e82611d2f816dffffffffffffffffffffffffffff8d1661336e565b611d49846dffffffffffffffffffffffffffff8d1661336e565b612313565b611d589082613305565b9050611d867f0000000000000000000000000000000000000000000000000000000000000000828d8d612376565b611d90818661336e565b9450809c5060009150611ed7565b7f000000000000000000000000000000000000000000000000000000000000000073ffffffffffffffffffffffffffffffffffffffff168c73ffffffffffffffffffffffffffffffffffffffff1614611e53576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152601460248201527f494e56414c49445f4f55545055545f544f4b454e0000000000000000000000006044820152606401610646565b611e8b81611e71816dffffffffffffffffffffffffffff8c1661336e565b611d49856dffffffffffffffffffffffffffff8e1661336e565b611e959083613305565b9150611ec37f0000000000000000000000000000000000000000000000000000000000000000838d8d612376565b611ecd828761336e565b9550819c50600090505b611ee486868b8b8b6126f6565b611ef16110a18688613331565b600655604080518381526020810183905273ffffffffffffffffffffffffffffffffffffffff8d169133917fdccd412f0b1252819cb1fd330b93224ca42612892bb3f4f789976e6d81936496910160405180910390a35050600160085550989b9a5050505050505050505050565b42841015611fef576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152602560248201527f54726964656e7445524332303a205045524d49545f444541444c494e455f455860448201527f50495245440000000000000000000000000000000000000000000000000000006064820152608401610646565b73ffffffffffffffffffffffffffffffffffffffff8716600090815260036020526040812080547f0000000000000000000000000000000000000000000000000000000000000000917f6e71edae12b1b97f4d1f60370fef10105fa2faae0126114a169c64845d6126c9918b918b918b918761206a83613385565b9091555060408051602081019690965273ffffffffffffffffffffffffffffffffffffffff94851690860152929091166060840152608083015260a082015260c0810187905260e0016040516020818303038152906040528051906020012060405160200161210b9291907f190100000000000000000000000000000000000000000000000000000000000081526002810192909252602282015260420190565b604080517fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe08184030181528282528051602091820120600080855291840180845281905260ff88169284019290925260608301869052608083018590529092509060019060a0016020604051602081039080840390855afa158015612194573d6000803e3d6000fd5b50506040517fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe0015191505073ffffffffffffffffffffffffffffffffffffffff81161580159061220f57508873ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff16145b61229b576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152602660248201527f54726964656e7445524332303a20494e56414c49445f5045524d49545f53494760448201527f4e415455524500000000000000000000000000000000000000000000000000006064820152608401610646565b73ffffffffffffffffffffffffffffffffffffffff81811660009081526002602090815260408083208c8516808552908352928190208b9055518a815291928c16917f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b925910160405180910390a3505050505050505050565b6000806123407f000000000000000000000000000000000000000000000000000000000000000086613331565b90508061234f61271086613331565b6123599190613305565b6123638483613331565b61236d919061331d565b95945050505050565b801561245f576040517f97da6d3000000000000000000000000000000000000000000000000000000000815273ffffffffffffffffffffffffffffffffffffffff8581166004830152306024830152838116604483015260006064830152608482018590527f000000000000000000000000000000000000000000000000000000000000000016906397da6d309060a4016040805180830381600087803b15801561242057600080fd5b505af1158015612434573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906124589190613154565b5050612516565b6040517ff18d03cc00000000000000000000000000000000000000000000000000000000815273ffffffffffffffffffffffffffffffffffffffff85811660048301523060248301528381166044830152606482018590527f0000000000000000000000000000000000000000000000000000000000000000169063f18d03cc90608401600060405180830381600087803b1580156124fd57600080fd5b505af1158015612511573d6000803e3d6000fd5b505050505b50505050565b6040517ff7888aec00000000000000000000000000000000000000000000000000000000815273ffffffffffffffffffffffffffffffffffffffff7f00000000000000000000000000000000000000000000000000000000000000008116600483015230602483015260009182917f0000000000000000000000000000000000000000000000000000000000000000169063f7888aec9060440160206040518083038186803b1580156125ce57600080fd5b505afa1580156125e2573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190612606919061313b565b6040517ff7888aec00000000000000000000000000000000000000000000000000000000815273ffffffffffffffffffffffffffffffffffffffff7f0000000000000000000000000000000000000000000000000000000000000000811660048301523060248301529193507f00000000000000000000000000000000000000000000000000000000000000009091169063f7888aec9060440160206040518083038186803b1580156126b857600080fd5b505afa1580156126cc573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906126f0919061313b565b90509091565b6dffffffffffffffffffffffffffff851180159061272257506dffffffffffffffffffffffffffff8411155b6127ae576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152602560248201527f436f6e7374616e7450726f64756374506f6f6c57697468545741503a204f564560448201527f52464c4f570000000000000000000000000000000000000000000000000000006064820152608401610646565b6007547c0100000000000000000000000000000000000000000000000000000000900463ffffffff1661283257600780546dffffffffffffffffffffffffffff8681166e010000000000000000000000000000027fffffffff00000000000000000000000000000000000000000000000000000000909216908816171790556129d7565b6000612843640100000000426133be565b90508163ffffffff168163ffffffff161415801561287057506dffffffffffffffffffffffffffff841615155b156129355781810360006dffffffffffffffffffffffffffff86167bffffffffffffffffffffffffffff0000000000000000000000000000607087901b16816128bb576128bb613401565b600480549290910463ffffffff851681029092019055905060006dffffffffffffffffffffffffffff8616607088901b7bffffffffffffffffffffffffffff0000000000000000000000000000168161291657612916613401565b0490508263ffffffff1681026005600082825401925050819055505050505b6007805463ffffffff9092167c0100000000000000000000000000000000000000000000000000000000027bffffffffffffffffffffffffffffffffffffffffffffffffffffffff6dffffffffffffffffffffffffffff8881166e010000000000000000000000000000027fffffffff00000000000000000000000000000000000000000000000000000000909516908a161793909317929092169190911790555b60408051868152602081018690527fcf2aa50876cdfbb541206f89af0ee78d44a2abf8d328e37fa4917f982149848a910160405180910390a15050505050565b6006546000908015612b5d57612a436110a16dffffffffffffffffffffffffffff808716908816613331565b915080821115612b5d5760007f000000000000000000000000000000000000000000000000000000000000000073ffffffffffffffffffffffffffffffffffffffff1663c14ad8026040518163ffffffff1660e01b815260040160206040518083038186803b158015612ab557600080fd5b505afa158015612ac9573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190612aed919061313b565b905060006127108483612b00868361336e565b612b0a9089613331565b612b149190613331565b612b1e919061331d565b612b28919061331d565b90508015612b5a57612b5a7f000000000000000000000000000000000000000000000000000000000000000082612d7d565b50505b509392505050565b73ffffffffffffffffffffffffffffffffffffffff821660009081526001602052604081208054839290612b9a90849061336e565b909155505060008054829003815560405182815273ffffffffffffffffffffffffffffffffffffffff8416907fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef906020015b60405180910390a35050565b600081612c0757506000919050565b8160017001000000000000000000000000000000008210612c2d5760809190911c9060401b5b680100000000000000008210612c485760409190911c9060201b5b6401000000008210612c5f5760209190911c9060101b5b620100008210612c745760109190911c9060081b5b6101008210612c885760089190911c9060041b5b60108210612c9b5760049190911c9060021b5b60088210612ca75760011b5b6001818581612cb857612cb8613401565b048201901c90506001818581612cd057612cd0613401565b048201901c90506001818581612ce857612ce8613401565b048201901c90506001818581612d0057612d00613401565b048201901c90506001818581612d1857612d18613401565b048201901c90506001818581612d3057612d30613401565b048201901c90506001818581612d4857612d48613401565b048201901c90506000818581612d6057612d60613401565b049050808210612d705780612d72565b815b93505050505b919050565b80600080828254612d8e9190613305565b909155505073ffffffffffffffffffffffffffffffffffffffff82166000818152600160209081526040808320805486019055518481527fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef9101612bec565b80358015158114612d7857600080fd5b600060208284031215612e0f57600080fd5b8135612e1a8161348e565b9392505050565b600080600060608486031215612e3657600080fd5b8335612e418161348e565b92506020840135612e518161348e565b9150612e5f60408501612ded565b90509250925092565b600080600080600060a08688031215612e8057600080fd5b8535612e8b8161348e565b94506020860135612e9b8161348e565b9350612ea960408701612ded565b925060608601359150608086013567ffffffffffffffff80821115612ecd57600080fd5b818801915088601f830112612ee157600080fd5b813581811115612ef357612ef361345f565b604051601f82017fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe0908116603f01168101908382118183101715612f3957612f3961345f565b816040528281528b6020848701011115612f5257600080fd5b8260208601602083013760006020848301015280955050505050509295509295909350565b60008060408385031215612f8a57600080fd5b8235612f958161348e565b9150612fa360208401612ded565b90509250929050565b60008060408385031215612fbf57600080fd5b8235612fca8161348e565b946020939093013593505050565b60008060408385031215612feb57600080fd5b8235612ff68161348e565b915060208301356130068161348e565b809150509250929050565b60008060006060848603121561302657600080fd5b83356130318161348e565b925060208401356130418161348e565b929592945050506040919091013590565b600080600080600080600060e0888a03121561306d57600080fd5b87356130788161348e565b965060208801356130888161348e565b95506040880135945060608801359350608088013560ff811681146130ac57600080fd5b9699959850939692959460a0840135945060c09093013592915050565b600080602083850312156130dc57600080fd5b823567ffffffffffffffff808211156130f457600080fd5b818501915085601f83011261310857600080fd5b81358181111561311757600080fd5b86602082850101111561312957600080fd5b60209290920196919550909350505050565b60006020828403121561314d57600080fd5b5051919050565b6000806040838503121561316757600080fd5b505080516020909101519092909150565b6000815180845260005b8181101561319e57602081850181015186830182015201613182565b818111156131b0576000602083870101525b50601f017fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe0169290920160200192915050565b600073ffffffffffffffffffffffffffffffffffffffff808816835280871660208401525084604083015283606083015260a0608083015261322860a0830184613178565b979650505050505050565b6020808252825182820181905260009190848201906040850190845b8181101561328157835173ffffffffffffffffffffffffffffffffffffffff168352928401929184019160010161324f565b50909695505050505050565b602080825282518282018190526000919060409081850190868401855b828110156132e5578151805173ffffffffffffffffffffffffffffffffffffffff1685528601518685015292840192908501906001016132aa565b5091979650505050505050565b602081526000612e1a6020830184613178565b60008219821115613318576133186133d2565b500190565b60008261332c5761332c613401565b500490565b6000817fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff0483118215151615613369576133696133d2565b500290565b600082821015613380576133806133d2565b500390565b60007fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff8214156133b7576133b76133d2565b5060010190565b6000826133cd576133cd613401565b500690565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601260045260246000fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b73ffffffffffffffffffffffffffffffffffffffff811681146134b057600080fd5b5056fea264697066735822122027d1897cb10cc5280652e3761f3ac2ed8b3ba178ae4ab9450e289399c5e84dad64736f6c63430008070033'

export const computeConstantProductPoolAddress = ({
  factoryAddress,
  tokenA,
  tokenB,
  fee,
  twap
}: {
  factoryAddress: string
  tokenA: Token
  tokenB: Token
  fee: Fee
  twap: boolean
}): string => {
  // does safety checks
  const [token0, token1] = tokenA.sortsBefore(tokenB) ? [tokenA, tokenB] : [tokenB, tokenA]

  // Encode deploy data
  const deployData = defaultAbiCoder.encode(
    ['address', 'address', 'uint256', 'bool'],
    [token0.address, token1.address, fee, twap]
  )

  // Compute init code hash based off the bytecode, deployData & masterDeployerAddress
  const CONSTANT_PRODUCT_POOL_INIT_CODE_HASH = computePoolInitCodeHash({
    creationCode: CONSTANT_PRODUCT_POOL_CREATION_CODE,
    deployData,
    masterDeployerAddress: MASTER_DEPLOYER_ADDRESS
  })

  // Compute pool address
  return getCreate2Address(factoryAddress, keccak256(['bytes'], [deployData]), CONSTANT_PRODUCT_POOL_INIT_CODE_HASH)
}
